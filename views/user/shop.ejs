<link rel="stylesheet" href="/user/home/sidebar.css">

<section id="page-header">

</section>
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-2">
            <div class="sidebar">
                <!-- Search Section -->
                <div class="search-section">
                    <h3 class="section-title">Search Products</h3>
                    <div class="search-container">
                        <input type="text" class="search-input" placeholder="Search items..." />
                        <button class="search-button" onclick="filterByCategory()">Search</button>
                    </div>
                </div>

                <!-- Sort Section -->
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="section">
                                <h3 class="section-title">Sort By</h3>
                                <ul class="option-list">
                                    <li onclick="filterByCategory('lowest-high',1,this)" class="option-item">Price: Low
                                        to
                                        High</li>
                                    <li onclick="filterByCategory('high-low',1,this)" class="option-item">Price: High to
                                        Low
                                    </li>
                                    <li onclick="filterByCategory('newArrivals',1,this)" class="option-item">New
                                        Arrivals
                                    </li>
                                    <li onclick="filterByCategory('A-to-Z',1,this)" class="option-item">A-Z</li>
                                    <li onclick="filterByCategory('Z-to-A',1,this)" class="option-item">Z-A</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="divider"></div>

                <!-- Filter by Category -->
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="section">
                                <h3 class="section-title">Filter By Category</h3>
                                <ul class="option-list">
                                    <li onclick="filterByCategory('sports',1,this)" class="option-item">Sports</li>
                                    <li onclick="filterByCategory('normal',1,this)" class="option-item">Normal</li>
                                    <li onclick="filterByCategory('luxury',1,this)" class="option-item">Luxury</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Clear Filters Button -->
                <button class="apply-filter-btn" onclick="window.location.href = '/shop';">Clear Filters</button>
            </div>
        </div>

        <!-- Products Section -->
        <div class="col-md-10">
            <section id="product1" class="section-p1">
                <!-- Product Container -->
                <div class="pro-container">
                    <% if (products && products.length> 0) { %>
                        <% products.forEach(product=> { %>
                            <a href="/singleproduct/<%= product._id %>" style="text-decoration: none;">
                                <div class="pro">
                                    <img class="shirt" src="/uploads/<%= product.productImage[0] %>"
                                        alt="<%= product.productName %>">
                                    <div class="des">
                                        <span>
                                            <%= product.category.name %>
                                        </span>
                                        <h5>
                                            <%= product.productName %>
                                        </h5>
                                        <div class="star">
                                            <i class='bx bxs-star'></i>
                                            <i class='bx bxs-star'></i>
                                            <i class='bx bxs-star'></i>
                                            <i class='bx bxs-star'></i>
                                            <i class='bx bxs-star'></i>
                                        </div>
                                        <h4>₹<%= product.regularPrice %>
                                        </h4>
                                    </div>
                                    <a href="/cart"><i class='bx bx-cart cart'></i></a>

                                </div>
                            </a>
                            <% }) %>
                                <% } else { %>
                                    <p>No products available.</p>
                                    <% } %>
                </div>

            </section>
        </div>
    </div>
</div>

<!-- Pagination -->
<div class="row" id="pagination-row">
    <div class="col-md-12">
        <!-- Pagination Section -->
        <section id="pagination" class="section-p1">
            <% if (totalPages> 1) { %>
                <% if (currentPage> 1) { %>

                    <a onclick="filterByCategory('<%= filter %>','<%= currentPage + 1 %>')" style="cursor: pointer;">
                        Previous
                    </a>

                    <% } %>

                        <% for (let i=1; i <=totalPages; i++) { %>
                            <a onclick="filterByCategory('<%= filter %>','<%= i %>',)" style="cursor: pointer;">
                                <%= i %>
                            </a>
                            <% } %>


                                <% if (currentPage < totalPages) { %>
                                    <a onclick="filterByCategory('<%= filter %>','<%= currentPage + 1 %>')"
                                        style="cursor: pointer;">
                                        Next »
                                    </a>
                                    <% } %>
                                        <% } %>
        </section>

    </div>
</div>





<script>


    let currentSearchQuery = "";


    function filterByCategory(filter = "", page = 1, element) {
   
        const searchInputElement = document.querySelector(".search-input");
        if (searchInputElement) {
            currentSearchQuery = searchInputElement.value;
        }
        const xhr = new XMLHttpRequest();
        const url = currentSearchQuery ? `/shop/?filter=${filter}&page=${page}&search=${currentSearchQuery}`
            : `/shop/?filter=${filter}&page=${page}`;

        xhr.open("GET", url, true);
        xhr.setRequestHeader("Accept", "application/json");
        xhr.send();

        xhr.onreadystatechange = () => {
            if (xhr.readyState === 4 && xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);

                // Update Products
                const productContainer = document.querySelector(".pro-container");
                productContainer.innerHTML = response.products
                    .map((product) => `
                    <a href="/singleproduct/${product._id}" style="text-decoration: none;">
                        <div class="pro">
                            <img class="shirt" src="/uploads/${product.productImage[0]}" alt="${product.productName}">
                            <div class="des">
                                <span>${product.category.name}</span>
                                <h5>${product.productName}</h5>
                                <div class="star">
                                    <i class='bx bxs-star'></i>
                                    <i class='bx bxs-star'></i>
                                    <i class='bx bxs-star'></i>
                                    <i class='bx bxs-star'></i>
                                    <i class='bx bxs-star'></i>
                                </div>
                                <h4>₹${product.regularPrice}</h4>
                            </div>
                            <a href="/cart"><i class='bx bx-cart cart'></i></a>
                        </div>
                    </a>
                `)

                // Update Pagination
                updatePagination(response.currentPage, response.totalPages, filter);
            }
        };
    }

    function updatePagination(currentPage, totalPages, filter) {
        const pagination = document.getElementById("pagination");
        let html = "";

        if (filter === "newArrivals") {
            pagination.innerHTML = "";
            return;
        }


        if (totalPages > 1) {
            if (currentPage > 1) {

                const onclickHandler = `filterByCategory('${filter}', ${currentPage - 1})`
                

                html += `<a onclick="${onclickHandler}" style="cursor: pointer;">Previous</a>`;

            }

            for (let i = 1; i <= totalPages; i++) {

                const onclickHandler = `filterByCategory('${filter}', ${i})`
                

                html += `
                <a onclick="${onclickHandler}" style="cursor: pointer;">${i}</a>
            `;
            }

            if (currentPage < totalPages) {
                
                const onclickHandler = `filterByCategory('${filter}', ${currentPage + 1})`
                

                html += `<a onclick="${onclickHandler}" style="cursor: pointer;">Next »</a>`;
            }
        }

        pagination.innerHTML = html;
    }



</script>